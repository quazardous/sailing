#!/bin/bash
# Publish dist files to dist branch
# Called automatically after build
# Only includes files needed by install.sh

set -e

DIST_BRANCH="dist"
MAIN_BRANCH="main"

# Get last commit info from main
LAST_MSG=$(git log -1 --format="%s" "$MAIN_BRANCH" 2>/dev/null || git log -1 --format="%s")
LAST_SHA=$(git log -1 --format="%h" "$MAIN_BRANCH" 2>/dev/null || git log -1 --format="%h")

echo "Publishing dist (ref: $LAST_SHA)..."

# Save built files to temp
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# === Essential files only ===

# Compiled CLI
mkdir -p "$TEMP_DIR/dist"
cp -r dist/cli "$TEMP_DIR/dist/"

# Distribution templates (*.yaml-dist, *.md-dist)
cp dist/*.yaml-dist dist/*.md-dist "$TEMP_DIR/dist/" 2>/dev/null || true

# CLI wrappers
mkdir -p "$TEMP_DIR/bin"
cp bin/rudder bin/rudder-mcp "$TEMP_DIR/bin/"

# Prompting fragments
cp -r prompting "$TEMP_DIR/"

# Templates
cp -r templates "$TEMP_DIR/" 2>/dev/null || true

# Skill (source + build script)
mkdir -p "$TEMP_DIR/skill"
cp skill/build.sh "$TEMP_DIR/skill/"
cp skill/*.md "$TEMP_DIR/skill/" 2>/dev/null || true

# Commands
cp -r commands "$TEMP_DIR/" 2>/dev/null || true

# Package files (cli/package.json has runtime deps)
mkdir -p "$TEMP_DIR/cli"
cp cli/package.json "$TEMP_DIR/cli/"

# === Commit to dist branch ===

CURRENT_BRANCH=$(git branch --show-current)

if git show-ref --verify --quiet "refs/heads/$DIST_BRANCH"; then
  git checkout -q "$DIST_BRANCH"
else
  git checkout -q --orphan "$DIST_BRANCH"
  git rm -rf . >/dev/null 2>&1 || true
fi

# Clean and copy
git rm -rf . >/dev/null 2>&1 || true
cp -r "$TEMP_DIR"/* .

# Commit
git add -A
if git diff --cached --quiet; then
  echo "No changes to dist"
else
  git commit -q -m "chore(dist): $LAST_MSG"
  echo "✓ Committed: chore(dist): $LAST_MSG"
fi

git checkout -q "$CURRENT_BRANCH"

echo "✓ dist branch updated (use 'git push origin dist' to publish)"
