#!/bin/bash
#
# Rudder CLI wrapper
#
# Normal mode (installed in a project):
#   The CLI automatically finds the project root by walking up from the script
#   location to find .sailing/ directory.
#
# Dev mode (running from the maintenance repo):
#   Use SAILING_PROJECT env var or --root flag to point to a target project:
#
#   # Using environment variable
#   SAILING_PROJECT=/path/to/my/project ./bin/rudder task:list
#
#   # Using --root flag
#   ./bin/rudder --root /path/to/my/project task:list
#
#   # Or export for the session
#   export SAILING_PROJECT=/path/to/my/project
#   ./bin/rudder prd:list
#
# Priority:
#   1. --root flag (highest)
#   2. SAILING_PROJECT environment variable
#   3. Walk up from script location
#   4. Walk up from current directory (fallback)
#

SCRIPT_DIR="$(dirname "$(realpath "$0")")"
PROJECT_ROOT="$(realpath "$SCRIPT_DIR/..")"

# PROTECTION: This bin/rudder must be called from its own project directory
if [ "$(pwd)" != "$PROJECT_ROOT" ]; then
  echo "Error: This rudder must be called from $PROJECT_ROOT"
  echo "You are in: $(pwd)"
  echo ""
  echo "Either:"
  echo "  cd $PROJECT_ROOT && bin/rudder ..."
  echo "Or use the bin/rudder of your current project."
  exit 1
fi

MODE_FILE="$PROJECT_ROOT/SAILING_DIST"
TS_SRC="$PROJECT_ROOT/cli/rudder.ts"
DIST_ENTRY="$PROJECT_ROOT/dist/cli/rudder.js"

# Mode hint (optional): write "dist" or "dev" into SAILING_DIST to force behavior.
if [ -f "$MODE_FILE" ]; then
  MODE=$(cat "$MODE_FILE" | tr -d '[:space:]')
fi

# Prefer dist mode unless explicitly forced to dev
if [ "$MODE" != "dev" ] && [ -f "$DIST_ENTRY" ]; then
  exec node "$DIST_ENTRY" "$@"
fi

# Dev fallback: run TS directly if tsx is available
if command -v tsx >/dev/null 2>&1; then
  exec tsx "$TS_SRC" "$@"
fi

echo "rudder build not found. Run: npm run build (in $PROJECT_ROOT)"
exit 1
