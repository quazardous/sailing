{#
variables:
  prdId: string         # PRD ID (PRD-001)
  prdTitle: string|null # PRD title
  mode: worktree|inline # Execution mode
  sandbox: boolean      # Running in sandbox (MCP only)
  role: coordinator|agent # Actor role
  prdBody: string       # PRD content
  memory: string|null   # Project memory (optional)
#}
{% if role == 'coordinator' %}
# PRD Breakdown: {{ prdId }}

{% if prdTitle %}**{{ prdTitle }}**{% endif %}

---

## Your Role

You are the **coordinator**. You decompose the PRD into epics.

- ✅ Analyze the PRD and create epics
- ✅ Assign epics to milestones
- ✅ Define epic dependencies
- ❌ DO NOT create tasks (that's epic-breakdown)
- ❌ DO NOT implement anything

---

## Pre-flight

{% if sandbox %}
```json
{ "command": "memory:sync" }
{ "command": "prd:show {{ prdId }}" }
```
{% else %}
```bash
rudder memory:sync
rudder prd:show {{ prdId }}
```
{% endif %}

---

## Breakdown Guidelines

**Each epic = shippable increment**

When decomposing a PRD:
1. Group by feature/domain
2. Each epic = one deployable unit
3. Consider milestone boundaries
4. Target 3-7 tasks per epic

---

## Creating Epics

{% if sandbox %}
```json
{ "command": "epic:create {{ prdId }} \"Epic title\"" }
{ "command": "prd:milestone {{ prdId }} M1 --add-epic ENNN" }
{ "command": "deps:add ENNN --blocked-by EXXX" }
```
{% else %}
```bash
rudder epic:create {{ prdId }} "Epic title"
rudder prd:milestone {{ prdId }} M1 --add-epic ENNN
rudder deps:add ENNN --blocked-by EXXX
```
{% endif %}

---

## Editing Epic Content

{% if sandbox %}
```json
{ "command": "epic:edit ENNN -s \"## Description\" -c \"Epic description\"" }
```
{% else %}
```bash
rudder epic:edit ENNN -s "## Description" -c "Epic description"

# Or with patch:
cat <<'PATCH' | rudder epic:patch ENNN
<<<<<<< SEARCH
## Acceptance Criteria
=======
## Acceptance Criteria

- [ ] Feature X works
- [ ] Tests pass
>>>>>>> REPLACE
PATCH
```
{% endif %}

---

## Milestones

Assign epics to milestones based on delivery phases:

{% if sandbox %}
```json
{ "command": "prd:milestone {{ prdId }} M1 --add-epic E001 E002" }
{ "command": "prd:milestone {{ prdId }} M2 --add-epic E003" }
```
{% else %}
```bash
rudder prd:milestone {{ prdId }} M1 --add-epic E001 E002
rudder prd:milestone {{ prdId }} M2 --add-epic E003
```
{% endif %}

---

## Completion

After creating all epics:
{% if sandbox %}
```json
{ "command": "deps:validate --fix" }
{ "command": "epic:list --prd {{ prdId }}" }
```
{% else %}
```bash
rudder deps:validate --fix
rudder epic:list --prd {{ prdId }}
```
{% endif %}

{% else %}{# role == 'agent' #}
# Agent Mission: PRD Breakdown {{ prdId }}

{% if prdTitle %}**{{ prdTitle }}**{% endif %}

---

## Contract

You are an **agent** assigned to break down PRD {{ prdId }} into epics.

**Rudder CLI = Single Source of Truth.**

NEVER:
- Edit `.sailing/` files directly
- Create tasks (only epics)
- Make scope decisions not in spec

**If blocked**:
{% if sandbox %}
```json
{ "command": "task:log {{ prdId }} \"BLOCKED: <reason>\" --error" }
```
{% else %}
```bash
rudder task:log {{ prdId }} "BLOCKED: <reason>" --error
```
{% endif %}
Then STOP.

---

## Rudder CLI

{% if sandbox %}
```
Tool: mcp__rudder__cli
Arguments: { "command": "<command>" }
```
{% else %}
```bash
rudder <command>
```
{% endif %}

---

## Creating Epics

{% if sandbox %}
```json
{ "command": "epic:create {{ prdId }} \"Epic title\"" }
{ "command": "epic:edit ENNN -s \"## Description\" -c \"Content\"" }
```
{% else %}
```bash
rudder epic:create {{ prdId }} "Epic title"
rudder epic:edit ENNN -s "## Description" -c "Content"
```
{% endif %}

---

## Git

{% if mode == 'worktree' %}
**Commit**: `chore({{ prdId }}): breakdown into epics`
{% else %}
**No commit** - coordinator handles git.
{% endif %}

{% endif %}{# /role #}
---

# PRD Content

{{ prdBody }}

{% if memory %}
---

# Memory

{{ memory }}
{% endif %}
