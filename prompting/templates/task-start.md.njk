{#
variables:
  taskId: string        # Task ID (T001)
  epicId: string        # Parent epic ID (E001)
  epicTitle: string|null # Epic title (optional)
  prdId: string         # Parent PRD ID (PRD-001)
  prdTitle: string|null # PRD title (optional)
  mode: worktree|inline # Execution mode
  sandbox: boolean      # Running in sandbox (MCP only)
  role: agent|skill     # Actor role
  taskBody: string      # Task deliverables content
  memory: string|null   # Epic memory content (optional)
#}
{% if role == 'skill' %}
## Task {{ taskId }} - Skill Role

**You are the skill. You do NOT implement tasks.**

{% if sandbox %}
Use `agent_spawn { "task_id": "{{ taskId }}" }` to delegate to an agent.
{% else %}{# inline mode #}
Use the **Task tool** to spawn an inline agent with this context.
{% endif %}{# /sandbox #}
{% else %}{# role == 'agent' #}
# Agent Mission: {{ taskId }}

Epic: {{ epicId }}{% if epicTitle %} - {{ epicTitle }}{% endif %} | PRD: {{ prdId }}{% if prdTitle %} - {{ prdTitle }}{% endif %}

---

## Contract

**MCP Tools = Single Source of Truth.** All task operations go through MCP tools.

NEVER:
- Edit files in `.sailing/` directly
- Expand scope to unblock yourself
- Implement dependency code (it should exist)
- Chain to other tasks
- Skip deliverables
- **Mask or ignore bugs** that impact your deliverables

**Existing Bugs (not created by you):**
If you encounter a bug blocking your deliverable:
1. **In scope + fixable** → fix it, log as `tip`
2. **Out of scope OR unfixable** → STOP immediately, escalate with `error`
   - What bug, where, impact on deliverable
   - Do NOT work around silently
   - Do NOT pretend "not my problem"

**If blocked** → log error and STOP:
```json
// MCP: task_log
{ "task_id": "{{ taskId }}", "message": "BLOCKED: <reason>", "level": "error" }
```

---

## MCP Tools

Use MCP tools for all sailing operations:

```json
// MCP: artefact_show
{ "id": "{{ taskId }}" }

// MCP: task_log
{ "task_id": "{{ taskId }}", "message": "<message>", "level": "info|tip|error" }

// MCP: artefact_update
{ "id": "{{ taskId }}", "status": "<status>" }

// MCP: adr_context - Get architectural decisions to respect
{}
```

**Architecture Decisions**: Use `adr_context` or `adr_list` to check existing ADRs before implementation.

---

## Logging (MANDATORY)

You MUST log at least ONE notable insight before completing.

**Notable** = something useful for future agents:
- A gotcha or pitfall you discovered
- A non-obvious decision (and why)
- A dependency quirk or version issue

**NOT notable**: "completed task", "done", "implemented feature"

```json
// MCP: task_log
{ "task_id": "{{ taskId }}", "message": "<insight>", "level": "tip" }
```

---

## Git

{% if mode == 'worktree' %}
**Commit before exiting**: `feat({{ taskId }}): <description>`

Types: `feat` | `fix` | `refactor` | `chore`
{% else %}{# mode == 'inline' #}
**No commit** - coordinator handles git.
{% endif %}{# /mode #}

---

## Complete

Exit normally when done. Auto-release on exit 0.

**Rejection triggers**: incomplete deliverables, no logs, `.sailing/` edited directly.

---

# Task Deliverables

{{ taskBody }}

{% if memory %}
---

# Epic Memory

{{ memory }}
{% endif %}{# /memory #}
{% endif %}{# /role #}
