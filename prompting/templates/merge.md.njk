{#
variables:
  taskId: string        # Task ID being merged (T001)
  epicId: string|null   # Parent epic ID
  prdId: string|null    # Parent PRD ID
  mode: worktree|inline # Execution mode (should be worktree)
  sandbox: boolean      # Running in sandbox
  role: coordinator|agent # Actor role
  taskBody: string|null # Task deliverables (optional)
  memory: string|null   # Epic memory (optional)
  conflictFiles: string|null # List of conflicting files (optional)
#}
{% if role == 'coordinator' %}
# Merge: {{ taskId }}

{% if epicId %}Epic: {{ epicId }}{% endif %}{% if prdId %} | PRD: {{ prdId }}{% endif %}

---

## Your Role

You are the **coordinator** handling a merge with conflicts.

- ✅ Resolve git conflicts
- ✅ Ensure code consistency
- ✅ Validate merged result
- ❌ DO NOT add new features
- ❌ DO NOT refactor beyond conflict resolution

---

## Context

{% if sandbox %}
```json
{ "command": "agent:status {{ taskId }}" }
{ "command": "worktree:status --json" }
```
{% else %}
```bash
# Check agent and worktree status
rudder agent:status {{ taskId }}
rudder worktree:status --json

# See what changed
git diff main...agent/{{ taskId }} --name-only

# Check for conflicts
git merge-tree $(git merge-base main agent/{{ taskId }}) main agent/{{ taskId }}
```
{% endif %}

---

## Merge Workflow

### If No Conflicts

{% if sandbox %}
```json
{ "command": "worktree:merge {{ taskId }}" }
```
{% else %}
```bash
rudder worktree:merge {{ taskId }}
```
{% endif %}

### If Conflicts Exist

```bash
# Create merge branch
git checkout -b merge/{{ taskId }}-to-main main
git merge agent/{{ taskId }} --no-commit

# Resolve conflicts...
# (edit files, git add resolved files)

# Complete merge
git commit -m "merge({{ taskId }}): resolved conflicts"
git checkout main
git merge merge/{{ taskId }}-to-main --ff-only
git branch -d merge/{{ taskId }}-to-main
```

---

## Resolution Guidelines

When resolving conflicts:

1. **Understand both sides**: Read the task deliverables and memory
2. **Preserve intent**: Keep the functionality from both branches
3. **Test if possible**: Ensure merged code works
4. **Don't add features**: Only resolve the conflict

---

## After Merge

{% if sandbox %}
```json
{ "command": "worktree:cleanup {{ taskId }}" }
{ "command": "task:update {{ taskId }} --status Done" }
```
{% else %}
```bash
rudder worktree:cleanup {{ taskId }}
rudder task:update {{ taskId }} --status Done
```
{% endif %}

{% else %}{# role == 'agent' #}
# Agent Mission: Merge {{ taskId }}

---

## Contract

You are an **agent** assigned to resolve merge conflicts for {{ taskId }}.

NEVER:
- Add new features
- Refactor beyond conflict resolution
- Make design decisions

**If unsure** → STOP and escalate:
{% if sandbox %}
```json
{ "command": "task:log {{ taskId }} \"BLOCKED: unclear conflict resolution\" --error" }
```
{% else %}
```bash
rudder task:log {{ taskId }} "BLOCKED: unclear conflict resolution" --error
```
{% endif %}

---

## Git Commands

```bash
# See conflicts
git status
git diff --name-only --diff-filter=U

# After resolving
git add <resolved-file>
git commit -m "merge({{ taskId }}): resolved conflicts"
```

---

{% if mode == 'worktree' %}
## Worktree Mode

You're in a merge worktree. Commit when resolved:
```bash
git commit -m "merge({{ taskId }}): <description of resolution>"
```
{% endif %}

{% endif %}{# /role #}
{% if taskBody %}
---

# Task Deliverables

{{ taskBody }}
{% endif %}

{% if memory %}
---

# Memory

{{ memory }}
{% endif %}

{% if conflictFiles %}
---

# Conflicting Files

{{ conflictFiles }}
{% endif %}
