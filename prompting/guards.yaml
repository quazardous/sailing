# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GUARDS.YAML â€” DÃ©finitions des guards CLI avec LiquidJS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Ce fichier centralise tous les guards (conditions de blocage) et post-prompts
# (recommendations) pour les commandes CLI.
#
# SYNTAXE:
#   vars:     Variables runtime requises (pas config)
#   checks:   Liste de conditions Ã©valuÃ©es dans l'ordre
#   posts:    Messages affichÃ©s aprÃ¨s succÃ¨s
#
# VARIABLES IMPLICITES (toujours disponibles):
#   - config.*  : Configuration rudder.yaml
#   - role      : Role actuel (agent|skill|coordinator)
#   - command   : Commande CLI en cours
#
# LEVELS:
#   - error: Bloque l'exÃ©cution (exit code)
#   - warn:  Affiche warning, continue
#   - info:  Information contextuelle
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# agent:spawn
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agent:spawn:
  vars:
    taskId: { type: string, required: true }
    gitClean: { type: boolean, required: true }
    hasCommits: { type: boolean, required: true }
    isGitRepo: { type: boolean, required: true }
    mcpRunning: { type: boolean, required: true }
    existingAgentStatus: { type: string }
    existingAgentPid: { type: number }
    isAgentRunning: { type: boolean }
    worktreeExists: { type: boolean }
    isDirty: { type: boolean }
    commitsAhead: { type: number, default: 0 }
    isMerged: { type: boolean }
    useWorktree: { type: boolean }
    resumeMode: { type: boolean, default: false }

  checks:
    # Role enforcement
    - id: role_denied
      when: "{{ role == 'agent' }}"
      level: error
      message: |
        âš  agent:spawn cannot be called with --role agent
        Agents cannot spawn other agents.
      hint: "Only skill or coordinator can spawn agents."
      exit: 1

    # Config check
    - id: subprocess_disabled
      when: "{{ config.agent.use_subprocess == false }}"
      level: error
      message: |
        âš  agent:spawn is disabled (use_subprocess: false)
      hint: "Use Task tool with `rudder context:load <operation> --role agent` to spawn agents inline."
      exit: 1

    # MCP server
    - id: mcp_not_running
      when: "{{ mcpRunning == false }}"
      level: error
      message: |
        âš  MCP server not running
        Agent sandbox requires MCP server.
      actions:
        - { cmd: "bin/rudder-mcp start", label: "Start MCP server" }
        - { cmd: "bin/rudder-mcp status", label: "Check server status" }
      exit: 1

    # Existing agent running
    - id: agent_running
      when: "{{ isAgentRunning == true }}"
      level: error
      message: |
        âš  Agent {{ taskId }} is still running (PID {{ existingAgentPid }})
      actions:
        - { cmd: "agent:wait {{ taskId }}", label: "Wait for completion" }
        - { cmd: "agent:kill {{ taskId }}", label: "Force terminate" }
        - { cmd: "agent:reap {{ taskId }}", label: "Wait + harvest results" }
      exit: 1

    # Unmerged work - uncommitted changes (not resume mode)
    - id: unmerged_work_dirty
      when: "existingAgentStatus and isDirty and isMerged == false and resumeMode == false"
      level: error
      message: |
        âš  Agent {{ taskId }} has uncommitted changes
      actions:
        - { cmd: "agent:spawn {{ taskId }} --resume", label: "Continue with existing work" }
        - { cmd: "agent:reap {{ taskId }}", label: "Merge + cleanup + respawn" }
        - { cmd: "agent:reject {{ taskId }}", label: "Discard work" }
      exit: 1

    # Unmerged work - commits ahead (not resume mode)
    - id: unmerged_work_commits
      when: "existingAgentStatus and commitsAhead > 0 and isMerged == false and resumeMode == false"
      level: error
      message: |
        âš  Agent {{ taskId }} has {{ commitsAhead }} commit(s) ahead
      actions:
        - { cmd: "agent:spawn {{ taskId }} --resume", label: "Continue with existing work" }
        - { cmd: "agent:reap {{ taskId }}", label: "Merge + cleanup + respawn" }
        - { cmd: "agent:reject {{ taskId }}", label: "Discard work" }
      exit: 1

    # Git repo check (worktree mode only)
    - id: not_git_repo
      when: "{{ useWorktree and isGitRepo == false }}"
      level: error
      message: |
        âš  use_worktrees requires a git repository
      hint: "Escalate for resolution."
      exit: 1

    # Uncommitted changes (worktree mode only)
    - id: uncommitted_main
      when: "{{ useWorktree and gitClean == false }}"
      level: error
      message: |
        âš  Working directory has uncommitted changes
        Worktree isolation requires a clean working directory.
      hint: "Escalate for resolution."
      exit: 1

    # No commits (worktree mode only)
    - id: no_commits
      when: "{{ useWorktree and hasCommits == false }}"
      level: error
      message: |
        âš  No commits in repository
        Git worktree requires at least one commit to create branches.
      hint: "Escalate for resolution."
      exit: 1

    # Orphaned worktree - dirty
    - id: orphaned_worktree_dirty
      when: "worktreeExists and isDirty and resumeMode == false"
      level: error
      message: |
        âš  Orphaned worktree exists for {{ taskId }}
        Has uncommitted changes
      actions:
        - { cmd: "agent:spawn {{ taskId }} --resume", label: "Continue with existing work" }
        - { cmd: "agent:sync", label: "Recover into state" }
        - { cmd: "agent:reject {{ taskId }}", label: "Discard work" }
      exit: 1

    # Orphaned worktree - commits ahead
    - id: orphaned_worktree_commits
      when: "worktreeExists and commitsAhead > 0 and resumeMode == false"
      level: error
      message: |
        âš  Orphaned worktree exists for {{ taskId }}
        Has {{ commitsAhead }} commit(s) ahead
      actions:
        - { cmd: "agent:spawn {{ taskId }} --resume", label: "Continue with existing work" }
        - { cmd: "agent:sync", label: "Recover into state" }
        - { cmd: "agent:reject {{ taskId }}", label: "Discard work" }
      exit: 1

  posts:
    - id: spawn_failed
      when: "{{ exitCode != 0 }}"
      message: |
        Next steps:
      actions:
        - { cmd: "agent:log {{ taskId }}", label: "Check full log" }
        - { cmd: "agent:reject {{ taskId }}", label: "Discard work" }

    - id: diagnose_errors
      when: "{{ diagnoseErrors > 0 }}"
      message: |
        ğŸ›‘ STOP - Action required:
      actions:
        - { cmd: "agent:log-noise-add-filter <id> {{ taskId }} --contains \"pattern\"", label: "If noise: add filter" }
        - { cmd: "escalate", label: "If real issue: fix sandbox/environment" }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# worktree:merge
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
worktree:merge:
  vars:
    taskId: { type: string, required: true }
    branch: { type: string, required: true }
    parentBranch: { type: string, required: true }
    strategy: { type: string }
    uncommittedCount: { type: number, default: 0 }
    branching: { type: string }  # flat|epic|prd
    epicId: { type: string }
    prdId: { type: string }
    agentExists: { type: boolean }
    hasWorktree: { type: boolean }
    worktreeExists: { type: boolean }
    parentBranchExists: { type: boolean }

  checks:
    - id: agent_not_found
      when: "{{ agentExists == false }}"
      level: error
      message: "No agent found for task: {{ taskId }}"
      exit: 1

    - id: no_worktree
      when: "{{ hasWorktree == false }}"
      level: error
      message: "Task {{ taskId }} has no worktree"
      exit: 1

    - id: worktree_missing
      when: "{{ worktreeExists == false }}"
      level: error
      message: "Worktree not found for {{ taskId }}"
      exit: 1

    - id: parent_not_found
      when: "{{ parentBranchExists == false }}"
      level: error
      message: |
        Parent branch not found: {{ parentBranch }}
      hint: "Create it first or check branching strategy in PRD."
      exit: 1

    - id: uncommitted_changes
      when: "{{ uncommittedCount > 0 }}"
      level: error
      message: |
        Worktree has {{ uncommittedCount }} uncommitted changes
      actions:
        - { cmd: "git -C <worktree> commit -am 'wip'", label: "Commit changes first" }
        - { cmd: "agent:reject {{ taskId }}", label: "Or discard work" }
      exit: 1

    - id: invalid_strategy
      when: "{{ strategy and strategy != 'merge' and strategy != 'squash' and strategy != 'rebase' }}"
      level: error
      message: |
        Invalid merge strategy: {{ strategy }}
        Valid strategies: merge, squash, rebase
      exit: 1

  posts:
    - id: merge_success_epic
      when: "{{ branching == 'epic' }}"
      message: |
        Next: When epic is complete, merge epic/{{ epicId }} to prd/{{ prdId }}

    - id: merge_success_prd
      when: "{{ branching == 'prd' }}"
      message: |
        Next: When PRD is complete, merge prd/{{ prdId }} to main

    - id: merge_conflict
      when: "{{ mergeConflict == true }}"
      message: |
        âš  Merge conflicts detected
      actions:
        - { cmd: "/dev:merge {{ taskId }}", label: "Use merge skill to resolve" }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# worktree:preflight
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
worktree:preflight:
  vars:
    mainClean: { type: boolean, required: true }
    mainUncommitted: { type: number, default: 0 }
    mainBehind: { type: number, default: 0 }
    hasCommits: { type: boolean, required: true }
    pendingMerges: { type: array, default: [] }
    runningAgents: { type: array, default: [] }
    conflictCount: { type: number, default: 0 }

  checks:
    - id: uncommitted_main
      when: "{{ mainClean == false }}"
      level: error
      message: |
        Main branch has {{ mainUncommitted }} uncommitted changes
      exit: 1

    - id: no_commits
      when: "{{ hasCommits == false }}"
      level: error
      message: |
        No commits in repository
        Git worktree requires at least one commit.
      exit: 1

  posts:
    - id: behind_origin
      when: "{{ mainBehind > 0 }}"
      level: warn
      message: |
        âš  Main branch is {{ mainBehind }} commits behind origin
      actions:
        - { cmd: "git pull", label: "Pull latest changes" }

    - id: pending_merges
      when: "{{ pendingMerges.size > 0 }}"
      level: info
      message: |
        Pending merges: {{ pendingMerges | join: ", " }}

    - id: conflicts
      when: "{{ conflictCount > 0 }}"
      level: warn
      message: |
        âš  {{ conflictCount }} potential conflict(s) between running agents

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# agent:reap / agent:harvest
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agent:reap:
  vars:
    taskId: { type: string, required: true }
    agentExists: { type: boolean }
    agentPid: { type: number }
    isRunning: { type: boolean }
    waitTimeout: { type: boolean, default: false }

  checks:
    - id: agent_not_found
      when: "{{ agentExists == false }}"
      level: error
      message: |
        No agent found for task {{ taskId }}
      actions:
        - { cmd: "agent:spawn {{ taskId }}", label: "Start agent first" }
      exit: 1

    - id: agent_running_no_wait
      when: "{{ isRunning == true }}"
      level: error
      message: |
        Agent {{ taskId }} is still running (PID {{ agentPid }})
      actions:
        - { cmd: "agent:wait {{ taskId }}", label: "Wait for completion" }
        - { cmd: "agent:kill {{ taskId }}", label: "Force terminate" }
      exit: 1

    - id: timeout
      when: "{{ waitTimeout == true }}"
      level: error
      message: |
        Timeout waiting for agent {{ taskId }}
      actions:
        - { cmd: "agent:kill {{ taskId }}", label: "Force terminate" }
        - { cmd: "agent:log {{ taskId }}", label: "Check logs" }
      exit: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# assign:claim
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
assign:claim:
  vars:
    taskId: { type: string, required: true }
    epicId: { type: string }
    pendingMemory: { type: boolean, default: false }
    pendingEpics: { type: array, default: [] }
    forceMode: { type: boolean, default: false }

  checks:
    - id: pending_memory
      when: "{{ pendingMemory == true and forceMode == false }}"
      level: error
      message: |
        STOP: Pending memory consolidation required:
        {% for epic in pendingEpics %}
          {{ epic }} - has unconsolidated logs
        {% endfor %}
      actions:
        - { cmd: "memory:sync", label: "Consolidate logs first" }
      exit: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# assign:release
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
assign:release:
  vars:
    taskId: { type: string, required: true }
    hasTipLogs: { type: boolean }

  posts:
    - id: no_tip_logs
      when: "{{ hasTipLogs == false }}"
      level: warn
      message: |
        âš  No TIP logs found for {{ taskId }}
        Consider adding insights for the next agent.

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deps:validate
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deps:validate:
  vars:
    cycles: { type: array, default: [] }
    invalidBlockers: { type: array, default: [] }
    selfReferences: { type: array, default: [] }

  checks:
    - id: cycle_detected
      when: "{{ cycles.size > 0 }}"
      level: error
      message: |
        âœ— Dependency cycles detected:
        {% for cycle in cycles %}
          {{ cycle | join: " â†’ " }}
        {% endfor %}
      exit: 1

    - id: invalid_blockers
      when: "{{ invalidBlockers.size > 0 }}"
      level: error
      message: |
        âœ— Invalid blockers:
        {% for b in invalidBlockers %}
          {{ b.task }}: blocker {{ b.blocker }} not found
        {% endfor %}
      exit: 1

    - id: self_references
      when: "{{ selfReferences.size > 0 }}"
      level: error
      message: |
        âœ— Self-references:
        {% for t in selfReferences %}
          {{ t }}: cannot block itself
        {% endfor %}
      exit: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deps:show
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deps:show:
  vars:
    taskId: { type: string, required: true }
    epicBlockers: { type: array, default: [] }
    taskBlockers: { type: array, default: [] }

  posts:
    - id: epic_blocked
      when: "{{ epicBlockers.size > 0 }}"
      level: warn
      message: |
        âš  Epic blocked - waiting for: {{ epicBlockers | join: ", " }}

    - id: task_blocked
      when: "{{ taskBlockers.size > 0 }}"
      level: info
      message: |
        Blocked by: {{ taskBlockers | join: ", " }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# memory:sync
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
memory:sync:
  vars:
    pendingEpics: { type: array, default: [] }
    skippedSections: { type: array, default: [] }
    errors: { type: array, default: [] }

  posts:
    - id: pending_logs
      when: "{{ pendingEpics.size > 0 }}"
      level: warn
      message: |
        âš  PENDING LOGS: {{ pendingEpics.size }} epic(s)
        {% for e in pendingEpics %}
          {{ e }}
        {% endfor %}

    - id: skipped_sections
      when: "{{ skippedSections.size > 0 }}"
      level: warn
      message: |
        âš  {{ skippedSections.size }} skipped (section not found)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# context:load
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
context:load:
  vars:
    operation: { type: string }
    roleArg: { type: string }
    operationExists: { type: boolean }
    taskId: { type: string }
    taskExists: { type: boolean }

  checks:
    - id: missing_operation
      when: "{{ operation == nil and taskId == nil }}"
      level: error
      message: |
        Error: missing required argument 'operation'
        Usage: rudder context:load <operation> --role <role>
               rudder context:load --task <id>
               rudder context:load --list
      exit: 1

    - id: missing_role
      when: "{{ operation and roleArg == nil }}"
      level: error
      message: |
        Error: --role is required
        Usage: rudder context:load <operation> --role <role>
        Roles: agent, coordinator, skill
      exit: 1

    - id: operation_not_found
      when: "{{ operation and operationExists == false }}"
      level: error
      message: |
        Error: No context defined for operation '{{ operation }}'
      exit: 1

    - id: task_not_found
      when: "{{ taskId and taskExists == false }}"
      level: error
      message: |
        Error: Task not found: {{ taskId }}
      exit: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# archive:prd
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
archive:prd:
  vars:
    prdId: { type: string, required: true }
    prdExists: { type: boolean }
    prdStatus: { type: string }
    archiveExists: { type: boolean }
    allMode: { type: boolean, default: false }
    forceMode: { type: boolean, default: false }

  checks:
    - id: prd_not_found
      when: "{{ prdExists == false }}"
      level: error
      message: "âœ— PRD not found: {{ prdId }}"
      exit: 1

    - id: prd_not_done
      when: "{{ prdStatus != 'Done' and forceMode == false }}"
      level: error
      message: "âœ— PRD {{ prdId }} is not done (status: {{ prdStatus }})"
      exit: 1

    - id: archive_exists
      when: "{{ archiveExists == true }}"
      level: error
      message: "âœ— Archive destination already exists"
      exit: 1

    - id: all_force_conflict
      when: "{{ allMode == true and forceMode == true }}"
      level: error
      message: "âœ— --all and --force are incompatible"
      exit: 1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# story:validate
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
story:validate:
  vars:
    orphanStories: { type: array, default: [] }
    unlinkedStories: { type: array, default: [] }

  posts:
    - id: orphan_stories
      when: "{{ orphanStories.size > 0 }}"
      level: warn
      message: |
        âš ï¸ {{ orphanStories.size }} orphan stories (not referenced by any task)

    - id: unlinked_stories
      when: "{{ unlinkedStories.size > 0 }}"
      level: warn
      message: |
        âš ï¸ {{ unlinkedStories.size }} unlinked stories

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# gc:agents / gc:worktrees
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gc:cleanup:
  vars:
    unsafeOrphans: { type: array, default: [] }

  posts:
    - id: unsafe_orphans
      when: "{{ unsafeOrphans.size > 0 }}"
      level: warn
      message: |
        âš  Unsafe ({{ unsafeOrphans.size }}): would delete unmerged work
        {% for o in unsafeOrphans %}
          {{ o }}
        {% endfor %}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# agent:monitor
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
agent:monitor:
  vars:
    orphanAgentDirs: { type: array, default: [] }
    orphanWorktreeDirs: { type: array, default: [] }
    ghostAgents: { type: array, default: [] }
    terminalWithWorktree: { type: array, default: [] }

  posts:
    - id: orphan_agent_dirs
      when: "{{ orphanAgentDirs.size > 0 }}"
      level: warn
      message: |
        âš  Orphan agent dirs (not in db): {{ orphanAgentDirs | join: ", " }}

    - id: orphan_worktree_dirs
      when: "{{ orphanWorktreeDirs.size > 0 }}"
      level: warn
      message: |
        âš  Orphan worktree dirs (not in db): {{ orphanWorktreeDirs | join: ", " }}

    - id: ghost_agents
      when: "{{ ghostAgents.size > 0 }}"
      level: warn
      message: |
        âš  Ghost agents (in db, no dir): {{ ghostAgents | join: ", " }}

    - id: terminal_with_worktree
      when: "{{ terminalWithWorktree.size > 0 }}"
      level: warn
      message: |
        âš  Terminal agents with worktree (should clean):
        {% for a in terminalWithWorktree %}
          {{ a }}
        {% endfor %}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# renumber:check
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renumber:check:
  vars:
    duplicateEpics: { type: array, default: [] }
    duplicateTasks: { type: array, default: [] }

  posts:
    - id: duplicate_epics
      when: "{{ duplicateEpics.size > 0 }}"
      level: warn
      message: |
        âš  {{ duplicateEpics.size }} duplicate epic ID(s)

    - id: duplicate_tasks
      when: "{{ duplicateTasks.size > 0 }}"
      level: warn
      message: |
        âš  {{ duplicateTasks.size }} duplicate task ID(s)
